var TimeKnots={draw:function(r,b,e){var f={width:600,height:200,radius:10,lineWidth:4,colorTimeline:"#999",colorTip:"white",backgroundCircle:"#FFF",backgroundTip:"rgba(0,0,0,0.5)",dateFormat:"%Y/%m/%d %H:%M:%S",horizontalLayout:true,showLabels:false,labelFormat:"%Y/%m/%d %H:%M:%S",addNow:false,seriesColor:d3.scale.category20(),dateDimension:true,tipPosition:"float"};if(e!=undefined){for(var s in e){f[s]=e[s]}}if(f.addNow!=false){b.push({date:new Date(),name:f.addNowLabel||"Today"})}var d=f.tipPosition=="top"&&f.horizontalLayout==true;var n=null;if(d){f.height=f.height/2;n=d3.select(r).append("div").style("min-height",f.height)}else{n=d3.select(r).append("div").style("position","absolute")}n.style("opacity",0).style("font-family","Helvetica Neue").style("font-weight","300").style("background",f.backgroundTip).style("color",f.colorTip).style("padding","5px 10px 5px 10px").style("-moz-border-radius","8px 8px").style("border-radius","8px 8px");var q=d3.select(r).append("svg").attr("width",f.width).attr("height",f.height);function c(y,w){var x=w?1.5:1;var i=w?f.colorTimeline:f.backgroundCircle;return y.style("fill",function(z){if(z.color!=undefined){return z.color}return i}).transition().duration(100).attr("r",function(z){if(z.radius!=undefined){return Math.floor(f.radius*x)}return Math.floor(f.radius*x)})}function v(w,x){var i=x?0.9:0;return w.transition().duration(100).style("opacity",i)}function j(){var i=d3.selectAll(r.concat(" circle.timeline-event"));c(i,false)}function h(i){return(f.dateDimension)?new Date(i.date).getTime():i.value}var m=f.dateDimension?b.map(function(i){return Date.parse(i.date)}):b.map(function(i){return i.value});var u=d3.max(m);var o=d3.min(m);var p=(d3.max(b.map(function(i){return i.radius}))||f.radius)*1.5+f.lineWidth;var g=(f.horizontalLayout)?((f.width-2*p)/(u-o)):((f.height-2*p)/(u-o));var k=[];if(u==o){g=0;if(f.horizontalLayout){p=f.width/2}else{p=f.height/2}}linePrevious={x1:null,x2:null,y1:null,y2:null};q.selectAll("line").data(b).enter().append("line").attr("class","timeline-line").attr("x1",function(w){var i=f.horizontalLayout?Math.floor(g*(h(w)-o)+p):Math.floor(f.width/2);linePrevious.x1=i;return i}).attr("x2",function(i){if(linePrevious.x1!=null){return linePrevious.x1}else{return Math.floor(f.width/2)}}).attr("y1",function(w){var i=f.horizontalLayout?Math.floor(f.height/2):Math.floor(g*(h(w)-o))+p;linePrevious.y1=i;return i}).attr("y2",function(i){if(linePrevious.y1!=null){return linePrevious.y1}else{if(f.horizontalLayout){return Math.floor(f.height/2)}else{return Math.floor(g*(h(i)-o))}}}).style("stroke",function(i){if(i.color!=undefined){return i.color}else{if(i.series!=undefined){if(k.indexOf(i.series)<0){k.push(i.series)}return f.seriesColor(k.indexOf(i.series))}else{return f.colorTimeline}}}).style("stroke-width",f.lineWidth);q.selectAll("circle").data(b).enter().append("circle").attr("class","timeline-event").attr("r",function(i){if(i.radius!=undefined){return i.radius}return f.radius}).style("stroke",function(i){if(i.color!=undefined){return i.color}if(i.series!=undefined){if(k.indexOf(i.series)<0){k.push(i.series)}console.log(i.series,k,k.indexOf(i.series));return f.seriesColor(k.indexOf(i.series))}return f.colorTimeline}).style("stroke-width",function(i){if(i.lineWidth!=undefined){return i.lineWidth}return f.lineWidth}).style("fill",function(i){if(i.background!=undefined){return i.background}return f.backgroundCircle}).attr("cy",function(i){if(f.horizontalLayout){return Math.floor(f.height/2)}else{return Math.floor(g*(h(i)-o)+p)}}).attr("cx",function(w){if(f.horizontalLayout){var i=Math.floor(g*(h(w)-o)+p);return i}else{return Math.floor(f.width/2)}}).on("mouseover",function(x){if(f.dateDimension){var w=d3.time.format(f.dateFormat);var y=w(new Date(x.date))}else{var w=function(z){return z};var y=x.value}var i=x.name;n.html("");if(x.img!=undefined){n.append("img").style("float","left").style("margin-right","4px").attr("src",x.img).attr("width","64px")}n.append("strong").text(x.name).style("font-weight","bold");if(y!=""){n.append("date").text(y).style("display","inline-block").style("margin-left","10px")}if(x.description!=undefined){n.append("span").html(x.description).style("display","block")}if(d){j()}else{n.append("div").style("float","left")}c(d3.select(this),true);v(n,true);if(f.onMouseOver!=undefined){f.onMouseOver(d3.select(this),n)}}).on("mouseout",function(){if(d!=true){v(n,false);c(d3.select(this),false)}if(f.onMouseOut!=undefined){f.onMouseOut(d3.select(this),n)}});if(f.showLabels!=false){if(f.dateDimension){var t=d3.time.format(f.labelFormat);var l=t(new Date(o));var a=t(new Date(u))}else{var t=function(i){return i};var l=o;var a=u}q.append("text").text(l).style("font-size","70%").attr("x",function(i){if(f.horizontalLayout){return d3.max([0,(p-this.getBBox().width/2)])}return Math.floor(this.getBBox().width/2)}).attr("y",function(i){if(f.horizontalLayout){return Math.floor(f.height/2+(p+this.getBBox().height))}return p+this.getBBox().height/2});q.append("text").text(a).style("font-size","70%").attr("x",function(i){if(f.horizontalLayout){return f.width-d3.max([this.getBBox().width,(p+this.getBBox().width/2)])}return Math.floor(this.getBBox().width/2)}).attr("y",function(i){if(f.horizontalLayout){return Math.floor(f.height/2+(p+this.getBBox().height))}return f.height-p+this.getBBox().height/2})}q.on("mousemove",function(){tipPixels=parseInt(n.style("height").replace("px",""));return n.style("top",(d3.event.pageY-tipPixels-p)+"px").style("left",(d3.event.pageX+20)+"px")}).on("mouseout",function(){if(d==true){return n}else{return v(n,false).style("top","0px").style("left","0px")}})}};